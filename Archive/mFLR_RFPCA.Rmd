---
title: "Analyzing the effects of climate change on vegetation dynamics using Riemannian functional principal component analysis (RFPCA)"
author: "Theresa Meier, 05.09.2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

***

### Performing RFPCA with R package `RFPCA`

As a first step the function `RFPCA()` of R package `RFPCA` is applied to the recovery trajectories choosing the same setting as in prior analyses: 

- Patch 1
- Disturbances between 2015 and 2040
- 100 years of recovery

The function offers different possibilities on which manifold the FPCA is performed. Here, two approaches are compared: first, setting *Euclidean* is chosen, which yields (nearly) the same results as function `MFPCA()` from R package `MFPCA`. This serves as a baseline for the second approach, setting *Sphere*. Note that this setting is still not optimal for the compositional data structure at hand, since a spherical surface implies that each observation would need to have a constant norm (e.g., unit norm) rather than a sum constraint. 

Figure 1 shows the derived mean functions for both approaches:

***

```{r, echo=FALSE,out.width="49%",out.height="20%",fig.cap="**Figure 1:** Mean proportions of aboveground carbon derived by RFPCA without adjustments for proportions (left) and with respective adjustments (right).",fig.show='hold',fig.align='center'}
knitr::include_graphics(c("/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/RFPCA/png/means_Euclidean.png","/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/RFPCA/png/means_Sphere.png"))
``` 

***

**Question here:** Why are the mean functions different? Intuitively, the means should be the same no matter which approach is taken, aren't they?

Next, Figure 2 shows the first two PCs for both approaches. Note that in comparison to the MFPCA conducted in previous analyses, the sign of the second PCs is flipped.

***

```{r, echo=FALSE,out.width="49%",out.height="20%",fig.cap="**Figure 2:** First two PCs derived by RFPCA without adjustments for proportions (left) and with respective adjustments (right).",fig.show='hold',fig.align='center'}
knitr::include_graphics(c("/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/RFPCA/png/PCs_Euclidean.png","/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/RFPCA/png/PCs_Sphere.png"))
``` 

***

#### Comparison of the PC scores
In order to get an intuition, how the PC scores differ between the two approaches, Figure 3 shows the derived PC scores of both settings plotted against each other:

***

```{r, echo=FALSE,out.width="99%",out.height="20%",fig.cap="**Figure 3:** RFPCA scores and MFPCA scores plotted against each other for both PC 1 scores (left) and PC 2 scores (right).",fig.show='hold',fig.align='center'}
knitr::include_graphics("/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/RFPCA/png/comparison_PCs.png")
``` 

***

The RFPCA 1 scores are smaller for values below 0 and larger for values above 0 in comparison to MFPCA 1 values. High MFPCA 2 scores tend to be even higher calculated by RFPCA, while values around 0 do not show any concrete structure.

***

### Fitting the model with RFPCA scores
The same model as before is fitted to the first two PC scores derived by RFPCA. This still yields structured residuals as Figure 4 indicates:

***

```{r, echo=FALSE,out.width="99%",out.height="20%",fig.cap="**Figure 4:** Residuals and Q-Q plots for both PC 1 and PC 2 scores.",fig.show='hold',fig.align='center'}
knitr::include_graphics("/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/RFPCA/png/residuals_Sphere.png")
``` 

***

Also the true PC scores plotted against the second PC scores in Figure 5 indicate some structure, but less than before:

***

```{r, echo=FALSE,out.width="99%",out.height="20%",fig.cap="**Figure 5:** True vs. predicted PC scores derived on the training data set.",fig.show='hold',fig.align='center'}
knitr::include_graphics("/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/RFPCA/png/True_vs_fitted_train_Sphere.png")
``` 

***

Finally, the effects in terms of t-values are visualized in Figure 6 for first PC scores and in Figure 7 for second PC scores. The left plots show the t-values of the model fitted on MFPCA scores, the right plots show the effects of RFPCA scores. For a better comparison, the signs are flipped. The differences are only marginally for most of the parameters, but some conspicuous features become apparent:

**PC 1 scores:**

- The effect of the number of new seedlings of *pioneering broadleaf* (IBS) is no longer significant and even changes its sign. 
- The effect of the number of new seedlings of *tundra* (Tundra) is now significantly negative, indicating more needleleafed trees than on average.
- The effect of `PC1_climate` is still not significant, but changes its sign.

***

```{r, echo=FALSE,out.width="49%",out.height="20%",fig.cap="**Figure 6:** t-Values of the previous approach (left) and the *Sphere* approach (right) for first PC scores.",fig.show='hold',fig.align='center'}
knitr::include_graphics(c("/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/Model/Evaluation/png/t-values_PC1.png","/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/RFPCA/png/t-values_PC1_Sphere.png"))
``` 

***

**PC 2 scores:**

- Overall, the effects are in a higher range than before (similar as effects on PC 1 scores).
- The intercept is now significant.
- The sand fraction has now a significant negative effect, indicating more *temperate broadleaf* than on average.
- The pH value is no longer significant.
- The effects of the scenarios are large and all significantly negative, with the most extreme scenario having the most important effect on the occurrence of *temperate broadleaf*.
- The effects of the number of new seedlings of *needleleaf evergreen* (BNE) and *pioneering broadleaf* (IBS) are now significant, whereas the effect of *conifers (other)* (otherC) is no longer significant.
- The effect of the number of new seedlings of *tundra* (Tundra) is now significantly positive, indicating again more needleleafed trees than on average. It was significantly negative before.
- The effect of `PC1_climate` is still not significant and nearly vanishes.

***

```{r, echo=FALSE,out.width="49%",out.height="20%",fig.cap="**Figure 7:** t-Values of the previous approach (left) and the *Sphere* approach (right) for second PC scores.",fig.show='hold',fig.align='center'}
knitr::include_graphics(c("/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/Model/Evaluation/png/t-values_PC2.png","/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/RFPCA/png/t-values_PC2_Sphere.png"))
```

***

Overall, the *Sphere* approach mainly influences the effect on PC 2 scores.

***