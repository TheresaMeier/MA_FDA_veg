---
title: "Analyzing the effects of climate change on vegetation dynamics using functional data analysis"
author: "Theresa Meier, 03.07.2024"
output: html_document
---

***

## Functional Linear Regression - First Attempt

***

This document comprises the first attempt to fit a multivariate functional linear regression (mFLR) model, including performing FPCAs for functional variables The available covariates can be classified into four different types:

- PFT-dependent and time-varying: $Nuptake$ (nitrogen uptake per PFT)
- PFT-dependent only: $initial\_recruitment$, $recruitment\_ten\_years$, $previous\_state$, $time\_since\_dist$
- time-varying only: $tas\_yearlymax$, $tas\_yearlymin$, $tas\_yearlsmean$, $pr\_yearlysum$, $Nuptake\_total$
- Location dependent only: all soil related variables, i.e., $sand\_fraction$, $silt\_fraction$, $clay\_fraction$, $bulkdensity\_soil$, $ph\_soil$, $soilcarbon$

The first category is not modeled in this approach since there is need for further thinking. The PFT-dependent variables are transformed to PFT-wise covariates to match the general data shape (1803 observations, i.e., disturbed grid cells). For every disturbed grid cell, the soil related variables are already provided, so no further pre-processing is necessary. 

The time-varying, location dependent variables, i.e., the climate covariates and total nitrogen uptake are functional as the response. This implies that these covariates need to be transformed into multivariate data. In particular, in this first approach, the two climate variables $tas\_yearlymean$ and $pr\_yearlysum$ are represented as PC scores in the final model formulation, which result from two univariate FPCAs. Details on that are derived in the following.

### FPCA for Climate Covariates
#### Functional Fits

The first step in functional data analysis is to find an appropriate representation for the functional data. Figure 1 shows the functional fit for the average annual temperature ($tas\_yearlymean$). Note that there is no basis representation or smoother involved here. The black line indicates the mean curve. According to the curves, there is a slight trend towards warmer temperatures in the later decades of the study period. But this result is less meaningful considering the curves comprise all four scenarios.

***

![**Figure 1:** Functional fit for average annual temperature. ](/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/Model/(M)FPCA/png/BasisRep/BasisRep_mean_temp.png)

***

Figure 2 shows the functional fit for the annual average temperature for each scenario. As expected, with rising radial forcing, the annual mean temperature increases.


***

![**Figure 2:** Functional fit for average annual temperature per scenario. ](/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/Model/(M)FPCA/png/BasisRep/BasisRep_mean_temp_scen.png)

***

Figure 3 visualizes the annual sum of precipitation as function for each disturbed grid cell. The overall mean function indicates no trend in time across the study period. 

***

![**Figure 3:** Functional fit for annual precipitation ](/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/Model/(M)FPCA/png/BasisRep/BasisRep_precip.png)

***

As before, Figure 4 shows the scenario-wise functional fits of precipitation. Interestingly, one may hypothesize, that the more radial forcing, the less variation in precipitation.

***

![**Figure 4:** Functional fit for annual precipitation per scenario. ](/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/Model/(M)FPCA/png/BasisRep/BasisRep_precip_scen.png)

***

In general, all plots indicated that most of the variation in the data is captured by horizontal lines. This is proved by considering the principal components in the next section.

***

#### Principal Components
Performing a FPCA or MFPCA using the R package \texttt{MFPCA} includes steps within the functions which are not obvious to the user. For instance, the basis for the basis representation is set automatically, and the functional fits cannot be further explored. There is need for diving deeper into the functionality of this package to fully understand the basis representation used for running the FPCA or MFPCA.

Figure 5 and 6 show the first two principal components for both annual mean temperature and annual precipitation, respectively. As already indicated in the figures above, nearly all the variance can be captured by $y=0$.

***

![**Figure 5:** First and second principal component of covariate "Annual mean temperature". ](/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/Model/(M)FPCA/png/PCs/PCs_mean_temp.png)


***

![**Figure 6:** First and second principal component of covariate "Annual precipitation". ](/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/Model/(M)FPCA/png/PCs/PCs_precip.png)

***

Note that nearly all the variance in the data is already captured by the first PC for both variables. 

***

**Questions here:** What do I have to look at when I want to see that PC 1 and PC 2 are orthogonal to each other?

***

#### Reconstructions
The performed FPCAs serve as dimensionality reducer and smoothing operator. This becomes clear when looking at the reconstructed curves using the first 10 PCs visualized in Figure 7.

***

![**Figure 7:** Reconstructed curves using 10 PCs for both covariates "Annual mean temperature" and "Annual precipitation". ](/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/Model/(M)FPCA/png/Reconstruction/FPCA_reconstruct_all_compressed.png)

***

With these results, all provided covariates are prepared for modeling in the next step.

***

### Multivariate Functional Linear Regression (mFLR) model
Combining all covariates together results in the following model formula:

***

$\begin{pmatrix}\text{PC1} \\\text{PC2}\end{pmatrix}=  \ \begin{pmatrix}\beta_{0,1} \\\beta_{0,2}\end{pmatrix}+\begin{pmatrix}\beta_{1,1} \\ \beta_{1,2}\end{pmatrix} \cdot \text{Lon}+\begin{pmatrix}\beta_{2,1} \\ \beta_{2,2}\end{pmatrix} \cdot \text{Lat}+\begin{pmatrix}\beta_{3,1} \\ \beta_{3,2}\end{pmatrix} \cdot \text{sand_fraction} \\ +\begin{pmatrix}\beta_{4,1} \\ \beta_{4,2}\end{pmatrix} \cdot\text{silt_fraction}+\begin{pmatrix}\beta_{5,1} \\ \beta_{5,2}\end{pmatrix} \cdot \text{bulkdensity_soil}+\begin{pmatrix}\beta_{6,1} \\ \beta_{6,2}\end{pmatrix} \cdot \text{ph_soil} \\ +\begin{pmatrix}\beta_{7,1} \\ \beta_{7,2}\end{pmatrix} \cdot \text{soilcarbon}+\begin{pmatrix}\beta_{8,1} \\ \beta_{8,2}\end{pmatrix} \cdot \text{time_since_dist}\\+\begin{pmatrix}\beta_{9,1} \\ \beta_{9,2}\end{pmatrix} \cdot\text{Scenario}_{\text{SSP1-RCP2.6}} + \begin{pmatrix}\beta_{10,1} \\ \beta_{10,2}\end{pmatrix} \cdot\text{Scenario}_{\text{SSP3-RCP7.0}}+ \begin{pmatrix}\beta_{11,1} \\ \beta_{11,2}\end{pmatrix} \cdot\text{Scenario}_{\text{SSP5-RCP8.5}} \\+\begin{pmatrix}\beta_{12,1} \\ \beta_{12,2}\end{pmatrix} \cdot \text{initial_recruitment_BNE}+\begin{pmatrix}\beta_{13,1} \\ \beta_{13,2}\end{pmatrix} \cdot\text{initial_recruitment_IBS}+\begin{pmatrix}\beta_{14,1} \\ \beta_{14,2}\end{pmatrix} \cdot\text{initial_recruitment_TeBS} \\ +\begin{pmatrix}\beta_{15,1} \\ \beta_{15,2}\end{pmatrix} \cdot\text{initial_recruitment_Tundra}+\begin{pmatrix}\beta_{16,1} \\ \beta_{16,2}\end{pmatrix} \cdot\text{initial_recruitment_otherC}\\+\begin{pmatrix}\beta_{17,1} \\ \beta_{17,2}\end{pmatrix} \cdot\text{recruitment_ten_years_BNE}  +\begin{pmatrix}\beta_{18,1} \\ \beta_{18,2}\end{pmatrix} \cdot\text{recruitment_ten_years_IBS}+\begin{pmatrix}\beta_{19,1} \\ \beta_{19,2}\end{pmatrix} \cdot\text{recruitment_ten_years_TeBS}\\+\begin{pmatrix}\beta_{20,1} \\ \beta_{20,2}\end{pmatrix} \cdot\text{recruitment_ten_years_Tundra} +\begin{pmatrix}\beta_{21,1} \\ \beta_{21,2}\end{pmatrix} \cdot\text{recruitment_ten_years_otherC}\\+\begin{pmatrix}\beta_{22,1} \\ \beta_{22,2}\end{pmatrix} \cdot\text{previous_state_BNE}+\begin{pmatrix}\beta_{23,1} \\ \beta_{23,2}\end{pmatrix} \cdot \text{previous_state_IBS} +\begin{pmatrix}\beta_{24,1} \\ \beta_{24,2}\end{pmatrix} \cdot \text{previous_state_TeBS}\\+\begin{pmatrix}\beta_{25,1} \\ \beta_{25,2}\end{pmatrix} \cdot \text{previous_state_Tundra}+\begin{pmatrix}\beta_{26,1} \\ \beta_{26,2}\end{pmatrix} \cdot \text{previous_state_otherC}\\ +\begin{pmatrix}\beta_{27,1} \\ \beta_{27,2}\end{pmatrix} \cdot \text{PC1_temp}+\begin{pmatrix}\beta_{28,1} \\ \beta_{28,2}\end{pmatrix} \cdot \text{PC1_precip}+\begin{pmatrix}\epsilon_1\\\epsilon_2\end{pmatrix}$


***

Since the coil composition adds up to 1, one of the three composition is left out ($clay\_fraction$). Note that so far only linear effects are considered. All variables but $tas\_yearlymin$, $tas\_yearlymax$ and both nitrogen uptake variables ($Nuptake$ and $Nuptake\_total$) are considered here.

The model summary including the effect estimates are given here:

***

```{r echo=FALSE}
setwd("/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit")
lm_1 = readRDS("Scripts/MA_FDA_veg/04_Model/ModelRDS/lm_1.rds")
summary(lm_1)
```

***

For a valid interpretation, the first two PCs of the target are depicted at the end of this document.

**Questions here:** Is there any possibility to trace back the estimates on single PFTs? For instance, in PC1 we can see, the more extreme the scenario, the larger the $scenario$ estimate. Looking at the PCs at the bottom indicates more BNE, less IBS etc. But what happens for the single PFTs? E.g. I would suggest that the higher the temperature, the more TeBS, but how could I see that in the model? Is it even possible?

Next, the model is evaluated. Figure 6 shows residual and Q-Q plots for both PCs.

***

![**Figure 8:** Model residuals and Q-Q plots for both predicted PCs (on train data set). ](/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/Model/Evaluation/png/residuals.png)

***

Prior to running the model, the data was split into test and train data sets. In order to evaluate, how good the model performs on unseen data, Figure 9 shows the true PC scores vs. the predicted PC scores for the test set.

***

![**Figure 9:** True vs. fitted PC scores for unseen data. ](/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/Model/Evaluation/png/True_vs_fitted_test.png)

***

The basis functions estimated by the MFPCA for the target can now be used to transform the predicted PC scores of the unseen data into functional data. As an example, Figure 10 shows for four randomly picked disturbed grid cells, one for each scenario, the true functional fit and the predicted one from the model.

***

![**Figure 10:** True functional fit and predicted functional fit for four different example grid cells, one for each scenario. ](/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/Model/Evaluation/png/True_vs_fitted_examples.png)

***

To conclude, this first attempt seems rather promising, but there is need for improvement. 

**Possible adaptations:**

- MFPCA for all three climate variables
- FPCA for total nitrogen uptake and/or include PFT-wise nitrogen uptake (as MFPCA over all 5 PFTs)
- Check for measurement error (Berkson error?)
- Check for non-linear effects
- Check for correlations within covariates
- Variable selection (AIC/BIC, forward/backward/stepwise selection)

***

#### First two PCs of target MFPCA for interpretation

***

![**Figure 11:** First PC of target variable: BNE, IBS, otherC, TeBS, Tundra. ](/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/MFPCA/PCs/png/PCs_PC1.png)

***

![**Figure 12:** Second PC of target variable: BNE, IBS, otherC, TeBS, Tundra. ](/home/theresa/Schreibtisch/Theresa/STUDIUM/Master Statistics and Data Science/Masterarbeit/Scripts/Plots/MFPCA/PCs/png/PCs_PC2.png)

***